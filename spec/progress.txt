# Nutrition Agent Implementation Progress

## Phase 1: Shared Foundation
- [x] Created src/shared/enums.py with ActivityLevel, Objective, DietType, MealTime
- [x] Created src/shared/llm.py with get_llm() factory (Helicone proxy for OpenAI, Gemini support)
- [x] Created src/shared/tools.py with 6 migrated tools from rewoo_agent
- [x] Migrated auxiliary classes: StrictBaseModel, ResourceLoader, NutriFacts, ProcessedItem, NutritionResult
- [x] Updated src/shared/__init__.py to export all public symbols
- [x] Verified imports: `from src.shared import get_llm, ActivityLevel, generate_nutritional_plan`
- [x] Pre-commit passes (ruff check, ruff format, mypy)
Commit: 3bbd04b
Date: 2026-01-23

## Phase 2: Models
- [x] Create src/nutrition_agent/models/user_profile.py with UserProfile model
- [x] Create src/nutrition_agent/models/nutritional_targets.py with NutritionalTargets model
  - 9 fields: bmr, tdee, target_calories, protein_*, carbs_*, fat_*
  - Cross-field validators: macro percentages sum, calorie coherence, gram alignment
  - Handles all objectives: fat_loss (0.8x), maintenance (1.0x), muscle_gain (1.1x)
  - Validated with 7 test scenarios (all passing)
- [x] Create src/nutrition_agent/models/diet_plan.py with Meal, Macronutrients, ShoppingListItem, DietPlan
  - Macronutrients: 6 fields for percentage and gram breakdown
  - Meal: 8 fields including MealTime enum, ingredients, preparation steps, optional alternative
  - ShoppingListItem: consolidated items with food name and quantity
  - DietPlan: 6 fields with 1-6 meals constraint, shopping list, day identifier
  - Validated with 15 constraint tests (all passing)
- [x] Update src/nutrition_agent/models/__init__.py to export all models
- [x] Pre-commit passes (ruff, mypy)
Commits: 86a9881 (UserProfile), 37696f2 (NutritionalTargets), a9672d9 (Diet Plan)
Date: 2026-01-23

## Phase 3: State and Prompts
- [x] Implement src/nutrition_agent/state.py with NutritionAgentState
  - 12 state fields across 5 workflow phases
  - Uses operator.add reducer for meals_completed accumulation
  - Inherits messages/copilotkit from CopilotKitState
  - Validated with architect-langgraph agent
  Commit: fc9c628
  Date: 2026-01-23
- [x] Create prompts/data_collection.py with DATA_COLLECTION_PROMPT
  - Prompt for conversational UserProfile extraction
  - Documents 9 fields (6 required, 3 optional)
  Commit: a670c77
  Date: 2026-01-23
- [x] Create prompts/recipe_generation.py with RECIPE_GENERATION_PROMPT
  - Main prompt with placeholders for meal context
  - LAST_MEAL_INSTRUCTION for precise budget closing
  - REGULAR_MEAL_INSTRUCTION for standard meals
  Commit: eb958d2
  Date: 2026-01-23
- [x] Update prompts/__init__.py to export prompts
  - Exports all 4 prompt constants
  - __all__ defines public API
  Commit: a552017
  Date: 2026-01-23

**Phase 3 Complete**

### Phase 3.5: Architecture Update - Parallel Batch Generation (v2)
- [x] Updated state.py for batch architecture:
  - Removed: current_meal_index, meals_completed (with operator.add reducer),
    skip_remaining_reviews, meals_approved
  - Added: daily_meals (list[Meal]), meal_generation_errors (dict[str, str]),
    selected_meal_to_change (str | None)
  - Changed: review_decision from ["approve", "change", "skip_all"] to
    ["approve", "change_meal", "regenerate_all"]
  - Removed operator import (no longer using reducer pattern)
- [x] Updated prompts/recipe_generation.py for parallel generation:
  - Removed sequential context: consumed_kcal, current_meal_index
  - Added macro context: daily_protein_grams, daily_carbs_grams, daily_fat_grams
  - Changed is_last_meal_instruction to special_instructions placeholder
  - Updated LAST_MEAL_INSTRUCTION with consumed_kcal and remaining_budget params
  - Added note about parallel generation context
- [x] Updated prompts/__init__.py docstring to reflect batch architecture
- [x] Updated spec/prd.md with complete batch architecture specification:
  - Section 3.3: New state fields
  - Section 3.4: New graph flow diagram
  - Section 3.5: Nodes 3, 3b, 4 updated for batch
  - Section 3.5.2: Hybrid parallel algorithm
  - Section 3.6: New conditional edges
  - Phase 4-5: Updated tasks and templates
  - Appendix D: Architecture change documentation
Date: 2026-01-24

## Phase 4: Nodes Implementation
- [x] Implement nodes/data_collection.py (LLM node)
  - Extracts UserProfile from conversation using llm.with_structured_output()
  - Validates required fields: age, gender, weight, height, activity_level, objective
  - Returns empty dict if profile already complete (skip re-extraction)
  - Handles extraction failures gracefully
  Commit: 2452436
  Date: 2026-01-24
- [x] Implement nodes/calculation.py (deterministic)
  - Uses Mifflin-St Jeor for BMR (aligned with tools.py)
  - TDEE = BMR × activity multiplier
  - Objective adjustments: 0.83 (fat_loss), 1.0 (maintenance), 1.15 (muscle_gain)
  - Macros: normal (weight-indexed protein) and keto support
  - Uses get_meal_distribution tool from src.shared
  Commit: 8900b27
  Date: 2026-01-24
- [x] Refactor generate_nutritional_plan tool (Option C)
  - Modified src/shared/tools.py: generate_nutritional_plan now returns dict[str, Any]
  - Added NutritionalPlanOutput Pydantic model for structured validation
  - Refactored nodes/calculation.py to use generate_nutritional_plan tool (DRY principle)
  - Updated tests/tools/test_generate_nutritional_plan.py for new return type
  - Added tests: test_fat_loss_calculation, test_keto_diet_macros
  - All 5 tests passing
  Date: 2026-01-24
- [x] Implement nodes/recipe_generation_batch.py (LLM node, parallel)
  - Hybrid parallel strategy: N-1 meals parallel, last meal sequential
  - Pre-validation loop: MAX_ATTEMPTS=3, ±5% regular, ±2% last meal
  - Uses calculate_recipe_nutrition tool for RAG validation
  - Helper _generate_single_meal_with_validation() for per-meal generation
  - Helper _parse_ingredients_for_rag() for ingredient parsing
  - Returns {"daily_meals": [...], "meal_generation_errors": {...}}
  Date: 2026-01-24
- [x] Implement nodes/recipe_generation_single.py (LLM node, single meal)
  - Regenerates ONE meal when user selects "change_meal" in HITL
  - Incorporates state.user_feedback into prompt
  - Uses same pre-validation loop as batch (MAX_ATTEMPTS=3, ±5%)
  - Returns updated daily_meals + resets review_decision to None
  - Clears selected_meal_to_change and user_feedback after use
  Date: 2026-01-24
- [x] Implement nodes/meal_review_batch.py (HITL with interrupt())
  - Uses langgraph.types.interrupt() for HITL pause
  - Sends complete meal plan in interrupt payload
  - User options: approve, change_meal, regenerate_all
  - Returns review_decision, selected_meal_to_change, user_feedback
  Date: 2026-01-24
- [x] Implement nodes/validation.py (deterministic)
  - Sums total calories from daily_meals
  - Validates against target with ±5% tolerance
  - Checks meal count matches expected
  - Uses consolidate_shopping_list tool
  - Builds final DietPlan with Macronutrients
  Date: 2026-01-24
- [x] Update nodes/__init__.py
  - Exports all 6 nodes: data_collection, calculation, recipe_generation_batch,
    recipe_generation_single, meal_review_batch, validation
  - Updated docstring for batch architecture
  Date: 2026-01-24

**Phase 4 Complete**

## Phase 5: Graph Assembly
- [ ] Implement graph.py with StateGraph, nodes, and conditional edges
- [ ] Export graph from __init__.py

## Phase 6: API Integration
- [ ] Register nutrition_agent in src/api/main.py
- [ ] Update langgraph.json if exists

## Phase 7: Testing & Quality Assurance
- [ ] Create tests/tools/test_shared_tools.py
- [ ] Create tests/quick_tool_tests/test_calculation_node.py
- [ ] Create tests/evaluation/eval_recipe_generation.py
